<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Gerenciamento de Salas e Reservas</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light p-5">

  <div class="container">
    <h1 class="text-center mb-5">Sistema de Salas e Reservas</h1>

    <!-- SE√á√ÉO SALAS -->
    <div class="card mb-5 shadow-sm">
      <div class="card-header bg-primary text-white">
        <h4>Gerenciar Salas</h4>
      </div>
      <div class="card-body">
        <form id="formSala" class="row g-3 mb-4">
          <div class="col-md-5">
            <input type="text" id="nome" class="form-control" placeholder="Nome da sala" required>
          </div>
          <div class="col-md-5">
            <input type="number" id="capacidade" class="form-control" placeholder="Capacidade" required>
          </div>
          <div class="col-md-2 d-grid">
            <button type="submit" class="btn btn-success">Adicionar</button>
          </div>
        </form>

        <h5>Salas Cadastradas</h5>
        <ul id="listaSalas" class="list-group"></ul>
      </div>
    </div>

    <!-- SE√á√ÉO RESERVAS -->
    <div class="card shadow-sm">
      <div class="card-header bg-secondary text-white">
        <h4>Gerenciar Reservas</h4>
      </div>
      <div class="card-body">
        <form id="formReserva" class="row g-3 mb-4">
          <div class="col-md-4">
            <select id="salaSelect" class="form-select" required>
              <option value="">Selecione uma sala</option>
            </select>
          </div>
          <div class="col-md-4">
            <input type="datetime-local" id="inicio" class="form-control" required>
          </div>
          <div class="col-md-4">
            <input type="datetime-local" id="fim" class="form-control" required>
          </div>
          <div class="col-12 d-grid">
            <button type="submit" class="btn btn-primary">Reservar</button>
          </div>
        </form>

        <h5>Reservas Atuais</h5>
        <ul id="listaReservas" class="list-group"></ul>
      </div>
    </div>
  </div>

  <script>
    // usar caminhos relativos para funcionar em dev e produ√ß√£o
    const API_SALAS = "/api/classrooms";
    const API_RESERVAS = "/reservas";

    // ---------- SALAS ----------
    async function carregarSalas() {
      try {
        const resp = await fetch(API_SALAS);
        if (!resp.ok) throw new Error("Falha ao carregar salas");
        const salas = await resp.json();

        const lista = document.getElementById("listaSalas");
        const select = document.getElementById("salaSelect");

        lista.innerHTML = "";
        select.innerHTML = '<option value="">Selecione uma sala</option>';

        (Array.isArray(salas) ? salas : []).forEach(sala => {
          const li = document.createElement("li");
          li.className = "list-group-item d-flex justify-content-between align-items-center";
          li.innerHTML = `<span><strong>${sala.nome || sala.name}</strong> - Capacidade: ${sala.capacidade ?? sala.capacity ?? ''}</span>`;
          const btn = document.createElement("button");
          btn.className = "btn btn-sm btn-danger";
          btn.textContent = "üóëÔ∏è";
          btn.onclick = () => removerSala(sala.id);
          li.appendChild(btn);
          lista.appendChild(li);

          const opt = document.createElement("option");
          opt.value = sala.id;
          opt.text = sala.nome || sala.name;
          select.appendChild(opt);
        });
      } catch (err) {
        console.error(err);
        alert("Erro ao carregar salas. Veja o console.");
      }
    }

    async function removerSala(id) {
      if (!confirm("Tem certeza que deseja remover esta sala?")) return;
      try {
        const resp = await fetch(`${API_SALAS}/${id}`, { method: "DELETE" });
        if (!resp.ok && resp.status !== 204) {
          const text = await resp.text();
          throw new Error(`Erro ao remover sala: ${resp.status} ${text}`);
        }
        await carregarSalas();
        await carregarReservas();
      } catch (err) {
        console.error(err);
        alert("N√£o foi poss√≠vel remover a sala. Veja o console.");
      }
    }

    document.getElementById("formSala").addEventListener("submit", async (e) => {
      e.preventDefault();
      const nome = document.getElementById("nome").value.trim();
      const capacidade = parseInt(document.getElementById("capacidade").value, 10) || 0;

      try {
        const resp = await fetch(API_SALAS, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ nome, capacidade })
        });
        if (!resp.ok) throw new Error("Erro ao criar sala");
        e.target.reset();
        carregarSalas();
      } catch (err) {
        console.error(err);
        alert("Erro ao criar sala. Veja o console.");
      }
    });

    // ---------- RESERVAS ----------
    async function carregarReservas() {
      try {
        const resp = await fetch(API_RESERVAS);
        if (!resp.ok) throw new Error("Falha ao carregar reservas");
        const reservas = await resp.json();

        const lista = document.getElementById("listaReservas");
        lista.innerHTML = "";

        (Array.isArray(reservas) ? reservas : []).forEach(res => {
          const inicio = res.inicio ? new Date(res.inicio).toLocaleString("pt-BR") : "";
          const fim = res.fim ? new Date(res.fim).toLocaleString("pt-BR") : "";
          const li = document.createElement("li");
          li.className = "list-group-item d-flex justify-content-between align-items-center";
          li.innerHTML = `<div><strong>${res.sala?.nome || "Sala removida"}</strong><br>In√≠cio: ${inicio}<br>Fim: ${fim}</div>`;
          const btn = document.createElement("button");
          btn.className = "btn btn-sm btn-danger";
          btn.textContent = "üóëÔ∏è";
          btn.onclick = () => removerReserva(res.id);
          li.appendChild(btn);
          lista.appendChild(li);
        });
      } catch (err) {
        console.error(err);
        alert("Erro ao carregar reservas. Veja o console.");
      }
    }

    async function removerReserva(id) {
      if (!confirm("Tem certeza que deseja remover esta reserva?")) return;
      try {
        const resp = await fetch(`${API_RESERVAS}/${id}`, { method: "DELETE" });
        if (!resp.ok && resp.status !== 204) {
          const text = await resp.text();
          throw new Error(`Erro ao remover reserva: ${resp.status} ${text}`);
        }
        carregarReservas();
      } catch (err) {
        console.error(err);
        alert("N√£o foi poss√≠vel remover a reserva. Veja o console.");
      }
    }

    document.getElementById("formReserva").addEventListener("submit", async (e) => {
      e.preventDefault();
      const salaId = document.getElementById("salaSelect").value;
      const inicio = document.getElementById("inicio").value;
      const fim = document.getElementById("fim").value;

      if (!salaId) { alert("Selecione uma sala."); return; }

      try {
        const resp = await fetch(API_RESERVAS, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            inicio,
            fim,
            sala: { id: Number(salaId) }
          })
        });
        if (!resp.ok) throw new Error("Erro ao criar reserva");
        e.target.reset();
        carregarReservas();
      } catch (err) {
        console.error(err);
        alert("Erro ao criar reserva. Veja o console.");
      }
    });

    // Inicializa tudo
    carregarSalas();
    carregarReservas();
  </script>
</body>
</html>